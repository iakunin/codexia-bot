version: '3.7'

services:
    db:
        container_name: codexia-bot-db
        image: postgres:11.5
        restart: always
        environment:
            POSTGRES_DB: codexia-bot
            POSTGRES_USER: codexia-bot
            POSTGRES_PASSWORD: codexia-bot
        ports:
            - 54322:5432

    zookeeper:
        container_name: codexia-bot-zookeeper
        image: zookeeper:3.4.14
        ports:
            - 2181:2181

    kafka:
        container_name: codexia-bot-kafka
        image: wurstmeister/kafka:2.12-2.4.0
        ports:
            - 9092:9092
        environment:
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_HOST_NAME: 172.17.0.1
            KAFKA_CREATE_TOPICS: "hackernews_item:1:1,codexia_project:1:1"

    kafka-manager:
        container_name: codexia-bot-kafka-manager
        image: solsson/kafka-manager@sha256:9da595ecbb733074a1d3c6091a1e0c384da4f4e1f19f4e16276062278da8e592
        ports:
            - "9001:9000"
        links:
            - zookeeper
            - kafka
        environment:
            ZK_HOSTS: zookeeper:2181
            APPLICATION_SECRET: letmein
            KM_ARGS: -Djava.net.preferIPv4Stack=true

    wiremock:
        container_name: codexia-bot-wiremock
        image: rodolpheche/wiremock
        volumes:
            - ./var/wiremock:/home/wiremock
        expose:
            - 80
        ports:
            - "8098:80"
        command:
            - "java"
            - "-cp"
            - "/var/wiremock/lib/*:/var/wiremock/extensions/*"
            - "com.github.tomakehurst.wiremock.standalone.WireMockServerRunner"
            - "--local-response-templating"
            - "--port"
            - "80"
            - "--verbose"
